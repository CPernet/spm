#!/usr/bin/env make -f
# Peer Makefile called by {SPM}/external/Makefile
#
# Copyright (C) 2011 Wellcome Trust Centre for Neuroimaging
#
# Guillaume Flandin
# $Id: Makefile.peer 4541 2011-11-03 16:37:35Z guillaume $

include ../src/Makefile.var

PEER =  peer/src/peer.$(SUF) peer/src/memprofile.$(SUF) \
	peer/src/watchdog.$(SUF) peer/src/time.$(SUF) \
	peer/src/ft_getopt.$(SUF)

PEERSLAVE = peer/src/peerslave.$(subst mex,,$(SUF))

PEERLIB = peer/src/peer.$(SUF).a

PEEROBS =\
	peer/src/announce.o peer/src/connect.o peer/src/discover.o \
	peer/src/expire.o peer/src/extern.o peer/src/localhost.o \
	peer/src/parser.o peer/src/peerinit.o \
	peer/src/security.o peer/src/smartcpu.o peer/src/smartmem.o \
	peer/src/smartshare.o peer/src/tcpserver.o peer/src/tcpsocket.o \
	peer/src/udsserver.o peer/src/util.o

ifeq (win64,$(PLATFORM))
    CFLAGS += -Ipeer/src/pthread-win32 -DPLATFORM_WIN64 -D__CLEANUP_C -DWIN32 -DSYSLOG=2 -DLOG_NOTICE=0 -DLOG_CRIT=0 -DLOG_INFO=0 -DLOG_DEBUG=0 -DLOG_ERR=0 
    LIBS += peer/src/pthread-win32/pthreadVC2_x64.lib -lws2_32 -lwininet
endif

all: $(PEER) $(PEERSLAVE)

clean:
	$(DEL) $(PEERLIB) $(PEEROBS)

distclean: clean
	$(DEL) $(PEER) $(PEERSLAVE)

install:
	$(COPY) $(PEER) peer/private/
	$(COPY) $(PEERSLAVE) peer/bin/

tarball: all
	$(TAR) -cf peer_mex.tar $(PEER) $(PEERSLAVE)

$(PEERLIB): $(PEEROBS) peer/src/compiler.h peer/src/extern.h peer/src/parser.h \
	peer/src/platform.h peer/src/platform_includes.h peer/src/swapbytes.h
	$(DEL) $@
ifeq (win64,$(PLATFORM))
	$(AR)$@ $(PEEROBS)
else
	$(AR) $@ $(PEEROBS)
endif

peer/src/%.o : peer/src/%.c
	$(MEX) -c $< -outdir $(dir $<) $(MEXEND)
ifneq (o,$(strip $(MOSUF)))
	$(MOVE) $(subst .o,.$(strip $(MOSUF)),$@) $@
endif

peer/src/%.$(SUF): peer/src/%.c
	$(MEX) $< -outdir $(dir $<) $(MEXEND)

peer/src/peer.$(SUF): peer/src/peer.c peer/src/peer.h $(PEERLIB)
	$(MEX) $< -outdir $(dir $<) $(PEERLIB) $(MEXEND)

peer/src/memprofile.$(SUF): peer/src/memprofile.c $(PEERLIB)
	$(MEX) $< -outdir $(dir $<) $(PEERLIB) $(MEXEND)

peer/src/watchdog.$(SUF): peer/src/watchdog.c $(PEERLIB)
	$(MEX) $< -outdir $(dir $<) $(PEERLIB) $(MEXEND)
        
ENGOPTS = $(dir $(MATLABROOT))engopts.sh

$(PEERSLAVE): peer/src/peerslave.c $(PEERLIB)
ifeq (,$(wildcard $(ENGOPTS)))
	$(warning ** peerslave executable not compiled as MATLAB engine unavailable. **)
else
	-$(MEX) -f $(ENGOPTS) $< -outdir $(dir $<) $(PEERLIB) $(MEXEND)
	-$(MOVE) peer/src/peerslave $(PEERSLAVE)
endif
