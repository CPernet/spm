% FORMAT spm_realign_ui
%____________________________________________________________________________
%
% spm_realign_ui prompts for a list of filenames representing a series
% of images that are to be realigned and invokes spm_realign.m
% The first image for each subject (or set of realignments) is taken to be
% the reference image (to which the remaining images are realigned)

function spm_realign_ui

global MODALITY

set(2,'Name','Realignment')
delete(get(2,'Children'));

n     = spm_input('number of subjects',1);
for i = 1:n
	P = spm_get(Inf,'.img',['select scans for subject ' num2str(i)]);
	eval(['P' num2str(i) ' = P;']);
end

Flags = 'm';
p = spm_input('Which option?',1,'m','Coregister only|Reslice Only|Coregister & Reslice',[1 2 3]);
if (p == 1 | p == 3) Flags = [Flags 'e']; end
if (p == 2 | p == 3) Flags = [Flags 'r']; end
p = spm_input('Interpolation Method?',2,'m','Bilinear Interpolation|Sinc Interpolation',[1 2]);
if (p == 2) Flags = [Flags 'sS']; end

if (any(Flags == 'r'))
	p = spm_input('Create what?',3,'m',' All Images (1..n)| Images 2..n| All Images + Mean Image| Mean Image Only',[1 2 3 4]);
	if (p == 2) Flags = [Flags 'n']; end
	if (p == 3) Flags = [Flags 'i']; end
	if (p == 4) Flags = [Flags 'Ni']; end
	if (~any(Flags == 'N'))
		if (spm_input('Mask the images?'       ,4,'y/n') == 'y') Flags = [Flags 'k']; end
		if (strcmp(MODALITY,'FMRI'))
			if (spm_input('Adjust for motion in Z?',5,'y/n') == 'y') Flags = [Flags 'c']; end
		end
	end
end

set(2,'Name','executing','Pointer','Watch'); drawnow
for i = 1:n
	eval(['P = P' num2str(i) ';'])
	spm_realign(P,Flags);
end
delete(get(2,'Children'));
set(2,'Name','','Pointer','Arrow'); drawnow
